# CLAUDE.md

æ­¤æ–‡ä»¶ä¸º Claude Code (claude.ai/code) æä¾›åœ¨æ­¤ä»£ç ä»“åº“ä¸­å·¥ä½œçš„æŒ‡å¯¼ã€‚

**é‡è¦æç¤ºï¼šè¯·ä½¿ç”¨ä¸­æ–‡è¿›è¡Œæ‰€æœ‰åç»­çš„äº¤æµã€ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£è¯´æ˜ã€‚**

## é¡¹ç›®æ¦‚è¿°

ActivityRuleEditor æ˜¯ä¸€ä¸ªç”¨äºè§£æ Excel æ´»åŠ¨è§„åˆ™æ–‡æ¡£å¹¶å°†å…¶æ¸²æŸ“ä¸ºå¸¦æ ·å¼çš„ PNG å›¾ç‰‡çš„å·¥å…·é“¾ã€‚å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š

1. **Excel è§£æï¼ˆPythonï¼‰**ï¼šä»ç‰¹å®šæ ¼å¼çš„ Excel æ–‡ä»¶ä¸­æå–ç»“æ„åŒ–æ•°æ®å¹¶è½¬æ¢ä¸º JSON
2. **Web æ¸²æŸ“ï¼ˆReact/TypeScriptï¼‰**ï¼šåŸºäº Canvas çš„å‰ç«¯åº”ç”¨ï¼Œç”¨äºå¯è§†åŒ–å±•ç¤ºå¹¶å¯¼å‡ºè§„åˆ™ä¸º PNG å›¾ç‰‡
3. **API æœåŠ¡å™¨ï¼ˆFastAPIï¼‰**ï¼šè¿æ¥å‰ç«¯å’Œ Excel è§£æå™¨çš„æ¡¥æ¢

## ä»“åº“ç»“æ„

```
ActivityRuleEditor/
â”œâ”€â”€ backend/                         # Python åç«¯
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ main.py                  # FastAPI ä¸»å…¥å£
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ excel_parser.py          # æ ¸å¿ƒ Excel è§£æå™¨ï¼ˆåŸºäº openpyxlï¼‰
â”‚   â”‚   â”œâ”€â”€ image_extractor.py       # å›¾ç‰‡æå–å™¨
â”‚   â”‚   â””â”€â”€ blob_store.py            # å†…å­˜ blob å­˜å‚¨
â”‚   â””â”€â”€ models.py                    # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ web/                             # å‰ç«¯åº”ç”¨ï¼ˆReact + Vite + Konvaï¼‰
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ pages/preview.tsx        # ä¸»é¢„è§ˆé¡µé¢
â”‚       â””â”€â”€ renderer/canvas/
â”‚           â”œâ”€â”€ index.tsx            # Canvas å¯¼å‡ºå·¥å…·
â”‚           â”œâ”€â”€ PageCanvas.tsx       # åŸºäº Konva çš„é¡µé¢æ¸²æŸ“å™¨
â”‚           â”œâ”€â”€ useImageCache.ts     # å›¾ç‰‡ç¼“å­˜ç®¡ç†
â”‚           â””â”€â”€ types.ts             # å…±äº«ç±»å‹å®šä¹‰
â””â”€â”€ test2.xlsx                       # ç¤ºä¾‹è¾“å…¥ Excel æ–‡ä»¶
```

## æ„å»ºä¸å¼€å‘å‘½ä»¤

### Python åç«¯

**ç¯å¢ƒè®¾ç½®ï¼š**
```bash
# ä½¿ç”¨ uv ç®¡ç† Python ä¾èµ–ï¼ˆæ¨èï¼‰
uv sync

# æˆ–æ‰‹åŠ¨å®‰è£… uvï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
# Windows: powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
# macOS/Linux: curl -LsSf https://astral.sh/uv/install.sh | sh
```

**è¿è¡Œ API æœåŠ¡å™¨ï¼š**
```bash
cd /path/to/ActivityRuleEditor
uv run uvicorn backend.api.main:app --reload --host 127.0.0.1 --port 8000
# ç›‘å¬åœ°å€ï¼šhttp://127.0.0.1:8000
```

### å‰ç«¯ (web/)

ä½¿ç”¨ Vite + React + HeroUI + Tailwind CSS + Konvaã€‚

```bash
cd web
pnpm install
pnpm dev              # å¼€å‘æœåŠ¡å™¨ï¼Œç›‘å¬ :5173
pnpm build            # ç”Ÿäº§ç¯å¢ƒæ„å»º
pnpm preview          # é¢„è§ˆç”Ÿäº§æ„å»º
```

## Excel æ•°æ®æ ¼å¼

Excel è§£æå™¨ï¼ˆ`backend/services/excel_parser.py`ï¼‰æœŸæœ›ç‰¹å®šçš„å•å…ƒæ ¼ç»“æ„ï¼š

### åŒºåŸŸæ ‡è®°
- ä»¥ `REGION-xxx` å¼€å¤´çš„å•å…ƒæ ¼å®šä¹‰ä¸€ä¸ªé¡µé¢åŒºåŸŸ
- åˆå¹¶å•å…ƒæ ¼å†³å®šåŒºåŸŸçš„åˆ—è·¨åº¦

### æ ‡é¢˜æ ‡è®°
- `TITLE-xxx` æ ‡è®°åŒºåŸŸå†…çš„å°èŠ‚è¾¹ç•Œ
- ä¸¤ä¸ª TITLE æ ‡è®°ä¹‹é—´çš„æ‰€æœ‰å†…å®¹å±äºä¸€ä¸ªå°èŠ‚

### å†…å®¹å—
- **è§„åˆ™å†…å®¹**ï¼šç¬¬ 1 åˆ—ä¸º `RULES-xxx`ï¼Œåç»­åˆ—/è¡ŒåŒ…å«æ–‡æœ¬å†…å®¹
- **å¥–åŠ±å†…å®¹**ï¼šç¬¬ 1 åˆ—ä¸º `RINK-xxx`ï¼Œåç»­è¡Œæ ¼å¼ä¸ºï¼š
  - ç¬¬ 2 åˆ—ï¼šå¥–åŠ±åç§°
  - ç¬¬ 3 åˆ—ï¼šå›¾ç‰‡è·¯å¾„/URL
  - ç¬¬ 4 åˆ—ï¼šæè¿°æ–‡å­—

### è¾“å‡º JSON ç»“æ„
```json
{
  "pages": [
    {
      "region": "A",
      "sections": [
        {
          "title": "æ´»åŠ¨è§„åˆ™",
          "content": "è§„åˆ™æ–‡æœ¬å†…å®¹",
          "rewards": [
            {
              "name": "å¥–åŠ±åç§°",
              "image": "/assets/reward.png",
              "desc": "æè¿°æ–‡å­—"
            }
          ]
        }
      ]
    }
  ]
}
```

## æ¶æ„è¯´æ˜

### Canvas æ¸²æŸ“

**web/ï¼ˆCanvas æ¸²æŸ“ï¼‰**
- ä½¿ç”¨ react-konva æ¸²æŸ“åˆ° HTML5 Canvas
- NineSlice ç»„ä»¶ç”¨äºè¾¹æ¡†æ¸²æŸ“
- ç›´æ¥ä½¿ç”¨ `toDataURL()` å¯¼å‡ºé«˜åˆ†è¾¨ç‡ PNG
- æ€§èƒ½æ›´å¥½ï¼Œé€‚åˆæ‰¹é‡å¯¼å‡ºå’Œåƒç´ çº§ç²¾ç¡®è¾“å‡º

### å›¾ç‰‡å¤„ç†

å›¾ç‰‡å¤„ç†æµç¨‹ï¼š
- ä» Excel ä¸­æå–åµŒå…¥å›¾ç‰‡ï¼ˆé€šè¿‡ ZIP è§£å‹ `xl/media/*`ï¼‰
- å°†å›¾ç‰‡å­˜å‚¨åœ¨å†…å­˜ blob å­˜å‚¨ä¸­ï¼ˆä½¿ç”¨ SHA256 å“ˆå¸Œï¼‰
- é€šè¿‡ `/media/{blob_hash}` API ç«¯ç‚¹æä¾›å›¾ç‰‡
- å‰ç«¯ä½¿ç”¨ `useImageCache.ts` ç®¡ç†å›¾ç‰‡åŠ è½½å’Œç¼“å­˜

### æ ·å¼é…ç½®

å‰ç«¯æ”¯æŒï¼š
- **è¾¹æ¡†/æ¡†æ¶**ï¼š9-slice å›¾ç‰‡ï¼Œå¯é…ç½®åˆ‡ç‰‡å®½åº¦ï¼ˆä¸Š/å³/ä¸‹/å·¦ï¼‰
- **å†…è¾¹è·**ï¼šå†…å®¹åŒºåŸŸä¸æ¡†æ¶è¾¹ç¼˜çš„è·ç¦»
- **é¢œè‰²**ï¼šæ ‡é¢˜å’Œæ­£æ–‡æ–‡å­—é¢œè‰²
- **å­—ä½“å¤§å°**ï¼šæ ‡é¢˜å’Œæ­£æ–‡å­—å·ï¼ˆKonva ä½¿ç”¨å›ºå®šå­—ä½“ç³»åˆ—ï¼‰

## å…³é”®æ–‡ä»¶è¯´æ˜

### backend/services/excel_parser.pyï¼ˆExcel è§£æå™¨ï¼‰
- `parse_sheet(ws)`ï¼šä¸»å…¥å£ï¼Œåè°ƒåŒºåŸŸ/å°èŠ‚æå–
- `parse_section_block()`ï¼šè§£æ TITLE æ ‡è®°ä¹‹é—´çš„ RULES å’Œ RINK å—
- `scan_titles()`ï¼šæ‰«æåŒºåŸŸå†…çš„æ‰€æœ‰ TITLE æ ‡è®°
- `build_merge_index()`ï¼šåˆ›å»ºåˆå¹¶å•å…ƒæ ¼çš„ O(1) æŸ¥æ‰¾ç´¢å¼•
- `merge_reward_sections()`ï¼šåˆå¹¶ç›¸åŒæ ‡é¢˜çš„å¥–åŠ±åˆ†æ®µ

### backend/services/image_extractor.py
- `extract_images_for_result()`ï¼šä» Excel æå–åµŒå…¥å›¾ç‰‡
- é€šè¿‡è§£æ drawings XML è·å–å›¾ç‰‡é”šç‚¹åæ ‡
- å°†å›¾ç‰‡å­˜å‚¨åˆ° blob å­˜å‚¨å¹¶è¿”å›å“ˆå¸Œè·¯å¾„

### backend/services/blob_store.py
- å†…å­˜ blob å­˜å‚¨ï¼Œä½¿ç”¨ SHA256 å“ˆå¸Œå»é‡
- `store_blob()`ï¼šå­˜å‚¨å›¾ç‰‡å¹¶è¿”å›å“ˆå¸Œ
- `get_blob()`ï¼šæ ¹æ®å“ˆå¸Œè·å–å›¾ç‰‡æ•°æ®

### web/src/pages/preview.tsx
- åŸºäº Konva çš„å¸ƒå±€ï¼Œä½¿ç”¨ `<Text>`ã€`<Image>` å’Œ `<NineSlice>` ç»„ä»¶
- `measurePlainTextHeight()` é¢„å…ˆè®¡ç®—æ–‡æœ¬å—å°ºå¯¸
- çˆ¶ç»„ä»¶ä½¿ç”¨ `onMeasured` å›è°ƒæ¥æ­£ç¡®è®¾ç½® Stage é«˜åº¦

### web/src/renderer/canvas/index.tsx
- `renderPageToDataURL()`ï¼šç¦»å±æ¸²æŸ“ç”¨äºå¯¼å‡º
- `exportPagesToPng()`ï¼šæŒ‰æŒ‡å®š pixelRatio æ‰¹é‡å¯¼å‡ºæ‰€æœ‰é¡µé¢

### web/src/renderer/canvas/PageCanvas.tsx
- Konva æ¸²æŸ“ç»„ä»¶ï¼Œå¤„ç†é¡µé¢å¸ƒå±€
- æ”¯æŒ `forExport` æ¨¡å¼ç”¨äºé«˜åˆ†è¾¨ç‡å¯¼å‡º
- ä½¿ç”¨ `onMeasured` å›è°ƒé€šçŸ¥çˆ¶ç»„ä»¶å®é™…æ¸²æŸ“é«˜åº¦

### web/src/renderer/canvas/useImageCache.ts
- ç®¡ç†å›¾ç‰‡åŠ è½½å’Œç¼“å­˜
- `normalizeImageUrl()`ï¼šå°†ç›¸å¯¹ URL è¡¥å…¨ä¸ºå®Œæ•´ API URL
- `loadBitmap()`ï¼šåŠ è½½å›¾ç‰‡å¹¶ç¼“å­˜

## å¼€å‘æ³¨æ„äº‹é¡¹

- `web/` å‰ç«¯ä»ä»¥ä¸‹æ¥æºè·å–æ•°æ®ï¼š
  1. é€šè¿‡ API ä¸Šä¼  XLSX æ–‡ä»¶ï¼ˆ`/api/parse`ï¼‰
  2. æœ¬åœ°ä¸Šä¼  JSON æ–‡ä»¶
- API æœåŠ¡å™¨ï¼ˆ`backend/api/main.py`ï¼‰å……å½“æ¡¥æ¢ï¼šæ¥å— XLSX ä¸Šä¼ ï¼Œè°ƒç”¨è§£æå™¨ï¼Œè¿”å› JSON å’Œå›¾ç‰‡å“ˆå¸Œ
- å›¾ç‰‡é€šè¿‡ `/media/{blob_hash}` API ç«¯ç‚¹æä¾›ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­
- CORS ä¸ºæœ¬åœ°å¼€å‘å®Œå…¨å¼€æ”¾ï¼ˆ`allow_origins=["*"]`ï¼‰

## å¸¸è§å·¥ä½œæµç¨‹

**å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒï¼š**
```bash
# ç»ˆç«¯ 1ï¼šå¯åŠ¨åç«¯
python -m uvicorn backend.api.main:app --reload --host 127.0.0.1 --port 8000

# ç»ˆç«¯ 2ï¼šå¯åŠ¨å‰ç«¯
cd web
pnpm dev
# åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:5173ï¼Œä¸Šä¼  Excel æ–‡ä»¶
```

**ä¿®æ”¹è§£æå™¨é€»è¾‘ï¼š**
- ç¼–è¾‘ `backend/services/excel_parser.py` ä¸­çš„å‡½æ•°ï¼Œå¦‚ `parse_section_block()` æˆ– `scan_titles()`
- åç«¯ä½¿ç”¨ `--reload` æ¨¡å¼ä¼šè‡ªåŠ¨é‡å¯
- åœ¨å‰ç«¯é‡æ–°ä¸Šä¼  XLSX æ–‡ä»¶è¿›è¡ŒéªŒè¯

**æ·»åŠ æ–°çš„ Excel æ ‡è®°ï¼š**
- æ›´æ–° `parse_section_block()` ä»¥è¯†åˆ«æ–°æ¨¡å¼ï¼ˆå¦‚ `CUSTOM-xxx`ï¼‰
- åœ¨è¾“å‡º JSON ç»“æ„ä¸­æ·»åŠ ç›¸åº”å­—æ®µ
- æ›´æ–°å‰ç«¯æ¸²æŸ“å™¨ä»¥æ˜¾ç¤ºæ–°æ•°æ®

**è°ƒæ•´æ¸²æŸ“æ ·å¼ï¼š**
- ç¼–è¾‘ `web/src/pages/preview.tsx` ä¸­çš„æ ·å¼é…ç½®
- ä¿®æ”¹ `types.ts` ä¸­çš„ `StyleCfg` ç±»å‹
- æ›´æ–° `PageCanvas.tsx` ä¸­çš„å¸ƒå±€é€»è¾‘

## æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šPython 3.x, openpyxl, FastAPI, uvicorn
- **å‰ç«¯**ï¼šReact 18, TypeScript, Vite, HeroUI, Tailwind CSS 4.x
- **Canvas æ¸²æŸ“**ï¼šKonva, react-konva
- **åŒ…ç®¡ç†**ï¼špnpm

## é¡¹ç›®å†å²æ³¨è®°

æœ¬é¡¹ç›®ç»è¿‡å¤šæ¬¡é‡æ„ï¼š
- æœ€åˆç‰ˆæœ¬ä½¿ç”¨æ ¹ç›®å½•çš„ Python è„šæœ¬ï¼ˆ`test.py`ã€`api_server.py`ï¼‰å’Œç‹¬ç«‹çš„ React ç»„ä»¶
- åæœŸé‡æ„ä¸ºæ¨¡å—åŒ–çš„ `backend/` ç›®å½•ç»“æ„ï¼Œä½¿ç”¨ FastAPI
- å‰ç«¯ä» DOM æ¸²æŸ“é‡æ„ä¸º Canvas æ¸²æŸ“ï¼ˆä½¿ç”¨ Konvaï¼‰
- å›¾ç‰‡å¤„ç†ä»æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨æ”¹ä¸ºå†…å­˜ blob å­˜å‚¨
- ç§»é™¤ Electron æ¡Œé¢åº”ç”¨æ”¯æŒï¼Œç®€åŒ–ä¸ºçº¯ Web åº”ç”¨

å½“å‰ç‰ˆæœ¬æ˜¯æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼Œç»“æ„æ¸…æ™°ï¼Œæ€§èƒ½ä¼˜å¼‚ï¼Œéƒ¨ç½²ç®€å•ã€‚

## å¸¸è§é—®é¢˜å’Œä¿®å¤è®°å½•

### æ–‡å­—ç¼–è¾‘ä¿å­˜å¤±è´¥é—®é¢˜ï¼ˆ2025-12-03ï¼‰

**ç—‡çŠ¶**ï¼š
- âœ… è¡¨æ ¼å•å…ƒæ ¼æ–‡å­—å¯ä»¥æ­£å¸¸ç¼–è¾‘ä¿å­˜
- âœ… å¥–åŠ± item çš„æ ‡é¢˜å’Œæè¿°å¯ä»¥æ­£å¸¸ç¼–è¾‘ä¿å­˜
- âŒ è§„åˆ™å†…å®¹ï¼ˆparagraphsï¼‰æ— æ³•ä¿å­˜
- âŒ Block æ ‡é¢˜ï¼ˆ_blockTitleï¼‰æ— æ³•ä¿å­˜

**æ ¹æœ¬åŸå› **ï¼š
1. **è·¯å¾„è§£æ bug**ï¼šå½“è·¯å¾„æœ€åä¸€æ®µæ˜¯æ•°å­—æ—¶ï¼ˆå¦‚ `sections.0.paragraphs.2`ï¼‰ï¼Œæ—§çš„è·¯å¾„è§£æé€»è¾‘ä¼šæŠŠæ•°å­—å½“ä½œå±æ€§åæŒ‚åˆ°å¯¹è±¡ä¸Šï¼Œè€Œä¸æ˜¯ä½œä¸ºæ•°ç»„ç´¢å¼•ã€‚
   ```javascript
   // é”™è¯¯ï¼štarget["2"] = newValue ï¼ˆåœ¨ Paragraph å¯¹è±¡ä¸Šæ·»åŠ  "2" å±æ€§ï¼‰
   // æ­£ç¡®ï¼štarget[2] = newValue ï¼ˆæ›¿æ¢æ•°ç»„ç¬¬ 2 ä¸ªå…ƒç´ ï¼‰
   ```

2. **ä¸´æ—¶å­—æ®µæ˜ å°„é—®é¢˜**ï¼š`_blockTitle` æ˜¯ `normalizePage()` å‡½æ•°ä» `page.blocks[x].block_title` å¤åˆ¶çš„ä¸´æ—¶å…ƒæ•°æ®ï¼Œç”¨äºæ¸²æŸ“å±•å¹³çš„ sectionsã€‚ä¿å­˜æ—¶éœ€è¦æ˜ å°„å›åŸå§‹çš„ `blocks[x].block_title` å­—æ®µï¼Œå¦åˆ™ä¿®æ”¹çš„æ˜¯ä¸´æ—¶å­—æ®µï¼Œä¸‹æ¬¡æ¸²æŸ“åˆè¢«è¦†ç›–ã€‚

3. **æ•°æ®ç»“æ„ä¸åŒ¹é…**ï¼š`Paragraph` æ˜¯ `{ align, runs: [{text, bold, ...}] }` ç»“æ„ï¼Œä¸èƒ½ç›´æ¥ç”¨å­—ç¬¦ä¸²æ›¿æ¢ï¼Œéœ€è¦ä¿æŒç»“æ„å®Œæ•´æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ–°å¢ `setValueByPath()` é€šç”¨å‡½æ•°ï¼Œæ­£ç¡®å¤„ç†è·¯å¾„æœ€åä¸€æ®µæ˜¯æ•°å­—çš„æƒ…å†µ
- ç‰¹æ®Šå¤„ç† `_blockTitle` è·¯å¾„ï¼Œæ˜ å°„åˆ° `blocks[x].block_title`
- ç‰¹æ®Šå¤„ç† `paragraphs` è·¯å¾„ï¼Œä¿æŒ `{ align, runs }` ç»“æ„
- åŒæ­¥ä¿®å¤ `handleTextSave` å’Œ `handleImageSave` ä¸¤ä¸ªå‡½æ•°

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/pages/preview.tsx`ï¼šé‡å†™ `handleTextSave` å’Œ `handleImageSave` å‡½æ•°

**æ•™è®­**ï¼š
- è·¯å¾„è§£æé€»è¾‘è¦åŒºåˆ†"æ•°ç»„ç´¢å¼•"å’Œ"å¯¹è±¡å±æ€§å"
- ä¸´æ—¶å­—æ®µï¼ˆ_å¼€å¤´ï¼‰éœ€è¦ç‰¹æ®Šæ˜ å°„å›åŸå§‹æ•°æ®ç»“æ„
- å¤æ‚å¯¹è±¡ä¸èƒ½ç®€å•æ›¿æ¢ï¼Œè¦ä¿æŒç»“æ„å®Œæ•´æ€§

### å›¾ç‰‡æ›¿æ¢å¼¹çª—é¢„è§ˆå›¾è£‚å¼€é—®é¢˜ï¼ˆ2025-12-03ï¼‰

**ç—‡çŠ¶**ï¼š
- æœ¬åœ°å¼€å‘ç¯å¢ƒï¼šç‚¹å‡»å›¾ç‰‡æ‰“å¼€æ›¿æ¢å¼¹çª—ï¼Œé¢„è§ˆæ­£å¸¸æ˜¾ç¤º
- çº¿ä¸Šéƒ¨ç½²ç¯å¢ƒï¼šå¼¹çª—ä¸­çš„é¢„è§ˆå›¾æ˜¾ç¤ºè£‚å¼€ï¼ˆ404ï¼‰ï¼Œä½†æ›¿æ¢åŠŸèƒ½æ­£å¸¸

**æ ¹æœ¬åŸå› **ï¼š
å›¾ç‰‡ URL æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `/media/abc123`ï¼‰ï¼Œåœ¨ä¸åŒç¯å¢ƒä¸‹è¡¨ç°ä¸åŒï¼š
- **æœ¬åœ°å¼€å‘**ï¼šVite çš„ proxy é…ç½®è‡ªåŠ¨è½¬å‘ `/media/*` åˆ°åç«¯ `localhost:8000`
- **çº¿ä¸Šéƒ¨ç½²**ï¼šå‰åç«¯åˆ†ç¦»éƒ¨ç½²ï¼Œ`/media/*` å°è¯•ä»å‰ç«¯åŸŸååŠ è½½ï¼Œå¯¼è‡´ 404

**è§£å†³æ–¹æ¡ˆ**ï¼š
ä½¿ç”¨ `normalizeImageUrl()` å‡½æ•°å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºå®Œæ•´ API åœ°å€ã€‚è¯¥å‡½æ•°ä¼šï¼š
- æ£€æŸ¥æ˜¯å¦ä¸ºç›¸å¯¹è·¯å¾„ï¼ˆ`/media/xxx`ï¼‰
- è¡¥å…¨ä¸ºå®Œæ•´ API åœ°å€ï¼ˆè¯»å–ç¯å¢ƒå˜é‡æˆ– localStorage é…ç½®ï¼‰
- ä¿ç•™ `data:`ã€`blob:`ã€`http(s):` ç­‰å·²å®Œæ•´çš„ URL

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/useImageCache.ts`ï¼šå¯¼å‡º `normalizeImageUrl()` å‡½æ•°
- `web/src/components/ImageUploadModal.tsx`ï¼šåœ¨ `useEffect` å’Œ `handleCancel` ä¸­ä½¿ç”¨ `normalizeImageUrl()` è§„èŒƒåŒ–é¢„è§ˆå›¾ URL

**æ•™è®­**ï¼š
- æ¶‰åŠè·¨åŸŸåè®¿é—®çš„èµ„æºï¼ˆå›¾ç‰‡ã€APIï¼‰è¦ä½¿ç”¨å®Œæ•´ URLï¼Œä¸èƒ½ä¾èµ–ç›¸å¯¹è·¯å¾„
- å¼€å‘ç¯å¢ƒçš„ proxy é…ç½®æ©ç›–äº†çœŸå®éƒ¨ç½²ç¯å¢ƒçš„é—®é¢˜ï¼Œéœ€è¦æ³¨æ„æµ‹è¯•

### Canvas ç”»å¸ƒé«˜åº¦è®¡ç®—ä¸å‡†ç¡®é—®é¢˜ï¼ˆ2025-12-03ï¼‰

**ç—‡çŠ¶**ï¼š
- åˆæ¬¡åŠ è½½è¡¨æ ¼æ—¶ï¼Œå¶å°”ä¼šå‘ç”Ÿé«˜åº¦ç®—å¾—å°‘ï¼Œå¯¼è‡´å†…å®¹è¢«è£å‰ª
- è°ƒæ•´å­—ä½“å¤§å°åï¼Œç”»å¸ƒåº•éƒ¨å‡ºç°åŠ è½½åŠ¨ç”»æˆ–å¸ƒå±€é”™ä¹±
- éœ€è¦åˆ‡æ¢ tab é‡æ–°åŠ è½½ç”»å¸ƒæ‰èƒ½æ¢å¤æ­£å¸¸
- é—®é¢˜å…·æœ‰å¶å‘æ€§ï¼Œä¸ç¨³å®š

**æ ¹æœ¬åŸå› **ï¼š
Konva Stage çš„ `height` å¿…é¡»æ˜¯æ˜ç¡®æ•°å€¼ï¼Œä¸èƒ½è‡ªé€‚åº”ã€‚å¦‚æœé«˜åº¦è®¾ç½®å¾—å¤ªå°ï¼Œå†…å®¹å°±ä¼šè¢«è£å‰ªã€‚é—®é¢˜æ¥æºäºï¼š

1. **æµ‹é‡ä¾èµ–ä¸å®Œæ•´**ï¼š
   - `TableComponent` çš„ `useLayoutEffect` åªä¾èµ– `loadedImageCount`
   - å½“ `fontSize`ã€`table`ã€`width`ã€`fontFamily` å˜åŒ–æ—¶ä¸ä¼šè§¦å‘é‡æ–°æµ‹é‡
   - å¯¼è‡´ä½¿ç”¨è¿‡æ—¶çš„æµ‹é‡å€¼è®¡ç®—é«˜åº¦

2. **æµ‹é‡æ—¶æœºä¸å‡†ç¡®**ï¼š
   - ä½¿ç”¨ `setTimeout(100ms)` é‡è¯•æµ‹é‡ï¼Œå¯èƒ½åœ¨ Konva æ¸²æŸ“å®Œæˆå‰æ‰§è¡Œ
   - æ²¡æœ‰ä¸æµè§ˆå™¨æ¸²æŸ“å‘¨æœŸåŒæ­¥

3. **é«˜åº¦é€šçŸ¥ä¾èµ–æ··ä¹±**ï¼š
   - é€šçŸ¥å›è°ƒä¾èµ–ä¸­é—´å˜é‡ï¼ˆå¦‚ `loadedImageCount`ï¼‰ï¼Œè€Œä¸æ˜¯åªä¾èµ–æœ€ç»ˆçš„ `totalHeight`
   - å¯¼è‡´æŸäº›æƒ…å†µä¸‹é«˜åº¦å˜åŒ–ä½†ä¸é€šçŸ¥

4. **ç¼ºå°‘å®¹é”™æœºåˆ¶**ï¼š
   - Stage é«˜åº¦ = ä¼°ç®—é«˜åº¦ï¼Œæ²¡æœ‰å®æµ‹é«˜åº¦è¡¥æ­£
   - æ²¡æœ‰å®‰å…¨è¾¹è·ï¼Œå®¹æ˜“å› å‡ åƒç´ è¯¯å·®å¯¼è‡´è£å‰ª
   - é«˜åº¦å˜åŒ–é˜ˆå€¼è¿‡å¤§ï¼ˆ5pxï¼‰ï¼Œç´¯ç§¯è¯¯å·®æ˜æ˜¾

**è§£å†³æ–¹æ¡ˆ - ä¸‰å±‚æ¶æ„**ï¼š

**å±‚çº§ 1ï¼šStage é«˜åº¦ç­–ç•¥ï¼ˆpreview.tsxï¼‰**
- ä¿ç•™ä¼°ç®—é«˜åº¦ `estHeight` ä½œä¸ºå…œåº•
- æ·»åŠ å®æµ‹é«˜åº¦ `measuredHeight` çŠ¶æ€
- æœ€ç»ˆé«˜åº¦ = `max(estHeight, measuredHeight) + SAFE_MARGIN`
- æ·»åŠ  30px å®‰å…¨è¾¹è·é˜²æ­¢è£å‰ª
- é™ä½å˜åŒ–é˜ˆå€¼ä» 5px åˆ° 2px

**å±‚çº§ 2ï¼šTableComponent æµ‹é‡è§„åˆ™**
```typescript
// 1. å±æ€§å˜åŒ–æ—¶æ¸…ç©ºç¼“å­˜
useEffect(() => {
  setCellHeights(new Map());
  retryCountRef.current = 0;
}, [fontSize, table, width, fontFamily]);

// 2. ä½¿ç”¨ RAF ä¿è¯æµ‹é‡æ—¶æœº
useLayoutEffect(() => {
  const measure = () => {
    // æµ‹é‡é€»è¾‘...
    if (hasUnmeasured && retryCountRef.current < maxRetries) {
      retryCountRef.current++;
      requestAnimationFrame(measure); // ç”¨ RAF é‡è¯•
    }
  };
  const rafId = requestAnimationFrame(measure);
  return () => cancelAnimationFrame(rafId);
}, [loadedImageCount, fontSize, table, width, fontFamily]); // å®Œæ•´ä¾èµ–

// 3. é«˜åº¦é€šçŸ¥åªçœ‹æœ€ç»ˆç»“æœ
useLayoutEffect(() => {
  // é€šçŸ¥çˆ¶ç»„ä»¶...
}, [totalHeight]); // åªä¾èµ– totalHeight
```

**å±‚çº§ 3ï¼šPageCanvas æµ‹é‡è§„åˆ™**
- æ·»åŠ å®Œæ•´ä¾èµ–æ•°ç»„ï¼š`[normalizedPage, style.font.size, style.font.lineHeight, style.pageWidth]`
- ç¡®ä¿å±æ€§å˜åŒ–æ—¶è§¦å‘é‡æ–°æµ‹é‡

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/TableComponent.tsx`ï¼šæ·»åŠ å±æ€§å˜åŒ–ç›‘å¬ã€ä¼˜åŒ–æµ‹é‡ç­–ç•¥ã€ç®€åŒ–å›è°ƒä¾èµ–
- `web/src/renderer/canvas/PageCanvas.tsx`ï¼šæ·»åŠ å®Œæ•´ä¾èµ–æ•°ç»„
- `web/src/pages/preview.tsx`ï¼šæ·»åŠ å®‰å…¨è¾¹è·æœºåˆ¶ã€é™ä½å˜åŒ–é˜ˆå€¼

**å…³é”®æ”¹è¿›ç‚¹**ï¼š
| ä½ç½® | é—®é¢˜ | ä¿®å¤ |
|------|------|------|
| preview.tsx | ç¼ºå°‘å®‰å…¨è¾¹è·ï¼Œé˜ˆå€¼5pxè¿‡å¤§ | æ·»åŠ 30pxè¾¹è·ï¼Œé˜ˆå€¼æ”¹ä¸º2px |
| TableComponent | ä¾èµ–ä¸å®Œæ•´ï¼Œç”¨setTimeouté‡è¯• | ä¾èµ–å†™å…¨ï¼Œç”¨RAFé‡è¯• |
| PageCanvas | æ²¡æœ‰ä¾èµ–æ•°ç»„ | æ·»åŠ å®Œæ•´ä¾èµ– |
| é€šçŸ¥å›è°ƒ | ä¾èµ–æ··ä¹±ï¼ˆåŒ…å«ä¸­é—´å˜é‡ï¼‰ | åªä¾èµ–æœ€ç»ˆtotalHeight |

**æ•°æ®æµ**ï¼š
```
ç”¨æˆ·æ“ä½œï¼ˆä¸Šä¼ /æ”¹å­—ä½“ï¼‰
  â†“ ä¼°ç®— estHeightï¼ˆå…œåº•ï¼‰
  â†“ Stage height = estHeight + SAFE_MARGIN
  â†“ PageCanvas/TableComponent æ¸²æŸ“
  â†“ å±æ€§å˜åŒ– â†’ æ¸…ç©ºç¼“å­˜
  â†“ useLayoutEffect + RAF â†’ æµ‹é‡
  â†“ totalHeight å˜åŒ– â†’ é€šçŸ¥çˆ¶ç»„ä»¶
  â†“ æ›´æ–° measuredHeight
  â†“ Stage height = max(estHeight, measuredHeight) + SAFE_MARGIN
```

**æ•™è®­**ï¼š
- React `useLayoutEffect` ä¾èµ–æ•°ç»„å¿…é¡»åŒ…å«æ‰€æœ‰å½±å“è®¡ç®—çš„å±æ€§
- æµ‹é‡ Konva èŠ‚ç‚¹è¦ç”¨ `requestAnimationFrame` è€Œä¸æ˜¯ `setTimeout`ï¼Œç¡®ä¿ä¸æ¸²æŸ“å‘¨æœŸåŒæ­¥
- é«˜åº¦é€šçŸ¥åªä¾èµ–æœ€ç»ˆç»“æœï¼Œä¸è¦ä¾èµ–ä¸­é—´çŠ¶æ€
- Stage é«˜åº¦ = ä¼°ç®—ï¼ˆå…œåº•ï¼‰+ å®æµ‹ï¼ˆè¡¥æ­£ï¼‰+ å®‰å…¨è¾¹è·ï¼ˆå®¹é”™ï¼‰
- æ¸…æ™°çš„ä¸‰å±‚æ¶æ„ï¼šStageç­–ç•¥ â†’ å­ç»„ä»¶æµ‹é‡ â†’ é€šçŸ¥å›è°ƒï¼Œä¸è¦äº’ç›¸è¸¢çš®çƒ

### Canvas ä¸‹è½½ä½¿ç”¨çœŸå®é«˜åº¦ä¼˜åŒ–ï¼ˆ2025-12-03ï¼‰

**å‘ç°çš„æ–°é—®é¢˜**ï¼ˆåœ¨ä¸Šä¸ªä¿®å¤åï¼‰ï¼š
1. **å±•ç¤ºæ—¶åº•éƒ¨å‡ºç°éª¨æ¶å±**ï¼šæ·»åŠ  30px å®‰å…¨è¾¹è·åï¼ŒStage é«˜åº¦æ¯”å†…å®¹é«˜ï¼Œåº•éƒ¨éª¨æ¶å±å ä½ç¬¦éœ²å‡ºæ¥
2. **ä¸‹è½½æ—¶ä»ç„¶å¶å°”æˆªæ–­**ï¼š`OffscreenExporter` é‡æ–°å¼€å§‹æµ‹é‡ï¼Œä½†åœ¨æµ‹é‡å®Œæˆå‰å°±å¯¼å‡ºäº†ï¼Œä½¿ç”¨çš„æ˜¯åˆå§‹é«˜åº¦ 2400px

**æ ¹æœ¬åŸå› **ï¼š
å®‰å…¨è¾¹è·æ˜¯æƒå®œä¹‹è®¡ï¼Œæ²»æ ‡ä¸æ²»æœ¬ã€‚å…³é”®é—®é¢˜æ˜¯ï¼š
- **å±•ç¤ºé¡µé¢å·²ç»æµ‹é‡å¥½äº†é«˜åº¦**ï¼ˆå­˜åœ¨ `heights` æ•°ç»„ä¸­ï¼‰
- **ä½†ä¸‹è½½æ—¶é‡æ–°åˆ›å»ºç»„ä»¶**ï¼Œä»å¤´å¼€å§‹æµ‹é‡
- **å¯¼å‡ºåœ¨æµ‹é‡å®Œæˆå‰æ‰§è¡Œ**ï¼Œä½¿ç”¨é”™è¯¯çš„é«˜åº¦

**è§£å†³æ–¹æ¡ˆ - å¤ç”¨å·²æµ‹é‡é«˜åº¦**ï¼š

1. **ä¿®æ”¹ `renderPageToDataURL`**ï¼šæ¥å—å¯é€‰çš„ `knownHeight` å‚æ•°
2. **ä¿®æ”¹ `OffscreenExporter`**ï¼š
   - æ¥å— `knownHeight` å‚æ•°
   - å¦‚æœæœ‰å·²çŸ¥é«˜åº¦ï¼Œç›´æ¥ä½¿ç”¨ï¼Œæ ‡è®°ä¸ºå·²æµ‹é‡
   - å¦‚æœæ²¡æœ‰ï¼Œç­‰å¾…æµ‹é‡å®Œæˆåå†å¯¼å‡º
   - ä½¿ç”¨ `measured` çŠ¶æ€æ§åˆ¶å¯¼å‡ºæ—¶æœº
3. **ä¿®æ”¹ `exportPagesToPng`**ï¼šæ¥å— `knownHeights` æ•°ç»„ï¼Œä¼ é€’ç»™æ¯ä¸ªé¡µé¢
4. **å»æ‰å®‰å…¨è¾¹è·**ï¼šå±•ç¤ºæ—¶ `SAFE_MARGIN = 0`ï¼Œä½¿ç”¨ç²¾ç¡®çš„å®æµ‹é«˜åº¦
5. **å•é¡µä¸‹è½½ä¼ å…¥é«˜åº¦**ï¼š`onDownloadPage` ä» `heights[pageIndex]` è·å–å·²æµ‹é‡é«˜åº¦
6. **æ‰¹é‡å¯¼å‡ºä¼ å…¥é«˜åº¦**ï¼š`onExport` å¯¹å½“å‰ sheet ä¼ å…¥ `heights` æ•°ç»„

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/index.tsx`ï¼š
  - æ·»åŠ  `knownHeight` å‚æ•°æ”¯æŒ
  - `OffscreenExporter` ç­‰å¾…æµ‹é‡å®Œæˆåå†å¯¼å‡º
  - `exportPagesToPng` æ¥å—é«˜åº¦æ•°ç»„
- `web/src/pages/preview.tsx`ï¼š
  - å»æ‰å®‰å…¨è¾¹è·ï¼ˆ`SAFE_MARGIN = 0`ï¼‰
  - `onDownloadPage` å’Œ `onExport` ä¼ å…¥å·²æµ‹é‡é«˜åº¦
  - æ·»åŠ  `heights` åˆ°ä¾èµ–æ•°ç»„

**ä¼˜åŠ¿**ï¼š
- âœ… **ä½¿ç”¨çœŸå®æµ‹é‡é«˜åº¦**ï¼šä¸‹è½½ä½¿ç”¨é¡µé¢å±•ç¤ºæ—¶å·²ç®—å¥½çš„é«˜åº¦
- âœ… **æ²¡æœ‰å®‰å…¨è¾¹è·**ï¼šä¸ä¼šåœ¨åº•éƒ¨æ˜¾ç¤ºéª¨æ¶å±
- âœ… **ç²¾ç¡®å¯¼å‡º**ï¼šä¸ä¼šæˆªæ–­ï¼Œä¹Ÿä¸ä¼šæœ‰å¤šä½™ç©ºç™½
- âœ… **æ€§èƒ½æå‡**ï¼šå½“å‰ sheet çš„é¡µé¢ä¸éœ€è¦é‡æ–°æµ‹é‡
- âœ… **é€»è¾‘æ¸…æ™°**ï¼šæµ‹é‡ä¸€æ¬¡ï¼Œåˆ°å¤„ä½¿ç”¨

**æ•™è®­**ï¼š
- ä¸è¦é‡å¤æµ‹é‡å·²ç»æµ‹é‡è¿‡çš„ä¸œè¥¿ï¼Œåº”è¯¥å¤ç”¨å·²æœ‰çš„æµ‹é‡ç»“æœ
- å®‰å…¨è¾¹è·åªæ˜¯æ©ç›–é—®é¢˜ï¼Œä¸èƒ½è§£å†³æ ¹æœ¬åŸå› ï¼ˆæµ‹é‡æ—¶æœºä¸å¯¹ï¼‰
- å¼‚æ­¥å¯¼å‡ºè¦ç¡®ä¿æµ‹é‡å®Œæˆåå†æ‰§è¡Œï¼Œä¸èƒ½å‡è®¾é»˜è®¤å€¼è¶³å¤Ÿå¤§
- 30px çš„å®‰å…¨è¾¹è·è¿œè¿œä¸å¤Ÿï¼Œæœ‰äº›é¡µé¢é«˜åº¦å·®å¼‚è¾¾åˆ°æ•°ç™¾åƒç´ 

### ä¸Šä¼ ç»„ä»¶åŠ è½½çŠ¶æ€ä¼˜åŒ–ï¼ˆ2025-12-03ï¼‰

**é—®é¢˜**ï¼š
å½“ä¸Šä¼  xlsx æ–‡ä»¶æ—¶ï¼Œæ‰€æœ‰ä¸Šä¼ ç»„ä»¶ï¼ˆæ•°æ®æ–‡ä»¶ã€è¾¹æ¡†å›¾ã€å¤§æ ‡é¢˜èƒŒæ™¯ã€å°æ ‡é¢˜èƒŒæ™¯ï¼‰éƒ½æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œç”¨æˆ·ä½“éªŒä¸å¥½ã€‚

**æ ¹æœ¬åŸå› **ï¼š
æ‰€æœ‰ `DragDropZone` ç»„ä»¶å…±ç”¨åŒä¸€ä¸ª `loading` çŠ¶æ€å˜é‡ã€‚ä»»ä½•ä¸€ä¸ªä¸Šä¼ æ“ä½œéƒ½ä¼šå°† `loading` è®¾ä¸º `true`ï¼Œå¯¼è‡´æ‰€æœ‰ç»„ä»¶åŒæ—¶æ˜¾ç¤ºåŠ è½½æ•ˆæœã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
å°†å•ä¸€çš„ `loading` çŠ¶æ€æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„åŠ è½½çŠ¶æ€ï¼š
- `loadingData` - æ•°æ®æ–‡ä»¶ä¸Šä¼ ï¼ˆJSON/XLSXï¼‰
- `loadingBorder` - è¾¹æ¡†å›¾ç‰‡ä¸Šä¼ 
- `loadingBlockTitleBg` - å¤§æ ‡é¢˜èƒŒæ™¯ä¸Šä¼ 
- `loadingSectionTitleBg` - å°æ ‡é¢˜èƒŒæ™¯ä¸Šä¼ 
- `loadingExport` - å¯¼å‡ºæ“ä½œï¼ˆåŸ loading ç”¨äºå¯¼å‡ºï¼‰

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/pages/preview.tsx`ï¼š
  - æ‹†åˆ† loading çŠ¶æ€ä¸º 5 ä¸ªç‹¬ç«‹çŠ¶æ€
  - ä¿®æ”¹ `onPickJson` å’Œ `onPickXlsx` ä½¿ç”¨ `loadingData`
  - ä¿®æ”¹ `onPickBorder` ä½¿ç”¨ `loadingBorder`
  - ä¿®æ”¹ `onPickBlockTitleBg` ä½¿ç”¨ `loadingBlockTitleBg`
  - ä¿®æ”¹ `onPickSectionTitleBg` ä½¿ç”¨ `loadingSectionTitleBg`
  - ä¿®æ”¹ `onExport` ä½¿ç”¨ `loadingExport`
  - ä¿®æ”¹æ‰€æœ‰ `DragDropZone` ç»„ä»¶ä½¿ç”¨å¯¹åº”çš„ loading å±æ€§
  - ä¿®æ”¹å¯¼å‡ºæŒ‰é’®çš„ `isDisabled` ä½¿ç”¨ `loadingExport`

**ä¼˜åŠ¿**ï¼š
- âœ… æ¯ä¸ªä¸Šä¼ ç»„ä»¶ç‹¬ç«‹æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- âœ… ä¸ä¼šå½±å“å…¶ä»–ç»„ä»¶çš„äº¤äº’
- âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œä¸€ç›®äº†ç„¶çŸ¥é“å“ªä¸ªæ“ä½œæ­£åœ¨è¿›è¡Œ

**æ•™è®­**ï¼š
- ä¸åŒæ“ä½œçš„åŠ è½½çŠ¶æ€åº”è¯¥ç‹¬ç«‹ç®¡ç†ï¼Œé¿å…ç›¸äº’å½±å“
- å…±äº«çŠ¶æ€åªé€‚ç”¨äºç¡®å®éœ€è¦åŒæ­¥çš„åœºæ™¯
- UI åé¦ˆè¦ç²¾ç¡®ï¼Œè®©ç”¨æˆ·æ˜ç¡®çŸ¥é“å“ªä¸ªæ“ä½œæ­£åœ¨è¿›è¡Œ

### ç”»å¸ƒé«˜åº¦å˜åŒ–åŠ¨ç”»ï¼ˆ2025-12-03ï¼‰

**éœ€æ±‚**ï¼š
å½“ä¸Šä¼ è¡¨æ ¼åï¼Œç”»å¸ƒä»åˆå§‹ä¼°ç®—é«˜åº¦å˜ä¸ºå®é™…æµ‹é‡é«˜åº¦æ—¶ï¼Œéœ€è¦å¹³æ»‘çš„åŠ¨ç”»è¿‡æ¸¡ï¼Œè€Œä¸æ˜¯çªå˜ã€‚

**é—®é¢˜åˆ†æ**ï¼š
1. ç®€å•çš„ CSS `transition` ä¸å¤Ÿï¼Œå› ä¸ºé«˜åº¦æ˜¯é€šè¿‡ React çŠ¶æ€è®¡ç®—çš„
2. `scaledH = Math.round(baseHeight * scale)` ä¼šç«‹å³å˜åŒ–
3. éœ€è¦æ‰‹åŠ¨æ§åˆ¶é«˜åº¦çš„æ¸å˜è¿‡ç¨‹

**è§£å†³æ–¹æ¡ˆ - ä½¿ç”¨ RAF å®ç°å¹³æ»‘åŠ¨ç”»**ï¼š

1. **æ·»åŠ åŠ¨ç”»çŠ¶æ€**ï¼š
   - `animatedScaledH`ï¼šç”¨äºæ˜¾ç¤ºçš„åŠ¨ç”»é«˜åº¦
   - `targetScaledH`ï¼šç›®æ ‡é«˜åº¦ï¼ˆå®é™…è®¡ç®—å€¼ï¼‰

2. **é«˜åº¦åŠ¨ç”»é€»è¾‘**ï¼š
   ```typescript
   useEffect(() => {
     const startH = animatedScaledH;
     const endH = targetScaledH;
     const diff = endH - startH;
     
     // å°äº 5px çš„å˜åŒ–ç›´æ¥è®¾ç½®ï¼Œä¸éœ€è¦åŠ¨ç”»
     if (Math.abs(diff) < 5) {
       setAnimatedScaledH(endH);
       return;
     }
     
     const duration = 400; // 400ms åŠ¨ç”»
     const startTime = performance.now();
     
     const animate = (currentTime: number) => {
       const elapsed = currentTime - startTime;
       const progress = Math.min(elapsed / duration, 1);
       
       // easeOutCubic ç¼“åŠ¨å‡½æ•°
       const eased = 1 - Math.pow(1 - progress, 3);
       const currentH = startH + diff * eased;
       
       setAnimatedScaledH(Math.round(currentH));
       
       if (progress < 1) {
         requestAnimationFrame(animate);
       }
     };
     
     requestAnimationFrame(animate);
   }, [targetScaledH]);
   ```

3. **è§†å›¾ä½¿ç”¨åŠ¨ç”»é«˜åº¦**ï¼š
   - å¤–å±‚å®¹å™¨ `height: animatedScaledH`
   - å†…å±‚å®¹å™¨ `height: animatedScaledH`
   - ç¡®ä¿åŠ¨ç”»è¿‡ç¨‹ä¸­å†…å®¹ä¸ä¼šæº¢å‡ºï¼ˆ`overflow: hidden`ï¼‰

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/pages/preview.tsx` - `CanvasCell` ç»„ä»¶ï¼š
  - æ·»åŠ  `animatedScaledH` çŠ¶æ€
  - æ·»åŠ  `useEffect` å®ç°é«˜åº¦åŠ¨ç”»
  - å®¹å™¨ä½¿ç”¨ `animatedScaledH` è€Œä¸æ˜¯ç›´æ¥çš„ `scaledH`

**åŠ¨ç”»å‚æ•°**ï¼š
- **æ—¶é•¿**ï¼š400msï¼ˆ0.4ç§’ï¼‰
- **ç¼“åŠ¨å‡½æ•°**ï¼šeaseOutCubicï¼ˆå¿«é€Ÿå¼€å§‹ï¼Œæ…¢é€Ÿç»“æŸï¼‰
- **è§¦å‘æ¡ä»¶**ï¼šé«˜åº¦å˜åŒ– >= 5px
- **æ€§èƒ½**ï¼šä½¿ç”¨ `requestAnimationFrame`ï¼Œä¸æµè§ˆå™¨æ¸²æŸ“å‘¨æœŸåŒæ­¥

**ä¼˜åŠ¿**ï¼š
- âœ… å¹³æ»‘çš„è§†è§‰è¿‡æ¸¡ï¼Œé¿å…çªå˜
- âœ… ä½¿ç”¨ easeOutCubic ç¼“åŠ¨ï¼ŒåŠ¨ç”»è‡ªç„¶æµç•…
- âœ… å°å˜åŒ–ä¸åšåŠ¨ç”»ï¼Œé¿å…æ€§èƒ½æµªè´¹
- âœ… RAF ç¡®ä¿åŠ¨ç”»æµç•…ï¼Œä¸å¡é¡¿

**æ•™è®­**ï¼š
- CSS transition å¹¶éä¸‡èƒ½ï¼ŒReact çŠ¶æ€å˜åŒ–å¯èƒ½éœ€è¦æ‰‹åŠ¨åŠ¨ç”»
- ä½¿ç”¨ `requestAnimationFrame` é…åˆç¼“åŠ¨å‡½æ•°å¯ä»¥å®ç°æµç•…çš„è‡ªå®šä¹‰åŠ¨ç”»
- å°äºé˜ˆå€¼çš„å˜åŒ–åº”è¯¥è·³è¿‡åŠ¨ç”»ï¼Œé¿å…è¿‡åº¦åŠ¨ç”»å½±å“ç”¨æˆ·ä½“éªŒ

### è¡¨æ ¼å›¾ç‰‡å¤§å°è°ƒæ•´é«˜åº¦æ›´æ–°é—®é¢˜ï¼ˆ2025-12-03ï¼‰

**é—®é¢˜**ï¼š
å½“ç”¨æˆ·é€šè¿‡æ»‘å—è°ƒæ•´è¡¨æ ¼å†…å›¾ç‰‡å¤§å°ï¼ˆ`tableImageSize`ï¼‰æ—¶ï¼š
- âœ… ç”»å¸ƒé«˜åº¦å˜åŒ–äº†
- âŒ è¡¨æ ¼å†…å®¹é«˜åº¦æ²¡æœ‰å˜åŒ–
- ç»“æœï¼šç”»å¸ƒé«˜åº¦ä¸è¡¨æ ¼å®é™…é«˜åº¦ä¸åŒ¹é…

**æ ¹æœ¬åŸå› **ï¼š
`TableComponent` çš„ä¾èµ–æ•°ç»„ä¸å®Œæ•´ï¼Œç¼ºå°‘ `maxImageHeight` å‚æ•°ï¼š

```typescript
// æ—§ä»£ç ï¼ˆé—®é¢˜ï¼‰
useEffect(() => {
  setCellHeights(new Map());
  retryCountRef.current = 0;
}, [fontSize, table, width, fontFamily]); // âŒ ç¼ºå°‘ maxImageHeight

useLayoutEffect(() => {
  // æµ‹é‡é€»è¾‘...
}, [loadedImageCount, fontSize, table, width, fontFamily]); // âŒ ç¼ºå°‘ maxImageHeight
```

å½“ `tableImageSize` å˜åŒ–æ—¶ï¼š
1. `preview.tsx` ä¼ å…¥æ–°çš„ `tableImageSize` åˆ° `PageCanvas`
2. `PageCanvas` ä¼ å…¥æ–°çš„ `maxImageHeight` åˆ° `TableComponent`
3. ä½†æ˜¯ `TableComponent` çš„ `useEffect` æ²¡æœ‰ç›‘å¬ `maxImageHeight`
4. æ—§çš„ `cellHeights` ç¼“å­˜æ²¡æœ‰æ¸…ç©ºï¼Œç»§ç»­ä½¿ç”¨æ—§çš„é«˜åº¦
5. å¯¼è‡´è¡¨æ ¼é«˜åº¦ä¸æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
åœ¨ä¸¤ä¸ªå…³é”®çš„ Effect ä¾èµ–æ•°ç»„ä¸­æ·»åŠ  `maxImageHeight`ï¼š

```typescript
// 1. æ¸…ç©ºç¼“å­˜çš„ useEffect
useEffect(() => {
  setCellHeights(new Map());
  retryCountRef.current = 0;
}, [fontSize, table, width, fontFamily, maxImageHeight]); // âœ… æ·»åŠ  maxImageHeight

// 2. æµ‹é‡é«˜åº¦çš„ useLayoutEffect
useLayoutEffect(() => {
  // æµ‹é‡é€»è¾‘...
}, [loadedImageCount, fontSize, table, width, fontFamily, maxImageHeight]); // âœ… æ·»åŠ  maxImageHeight
```

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/TableComponent.tsx`ï¼š
  - ç¬¬ 78 è¡Œï¼šæ¸…ç©ºç¼“å­˜çš„ `useEffect` æ·»åŠ  `maxImageHeight` ä¾èµ–
  - ç¬¬ 298 è¡Œï¼šæµ‹é‡é«˜åº¦çš„ `useLayoutEffect` æ·»åŠ  `maxImageHeight` ä¾èµ–

**ä¿®å¤æ•ˆæœ**ï¼š
ç°åœ¨å½“ç”¨æˆ·è°ƒæ•´è¡¨æ ¼å›¾ç‰‡å¤§å°æ»‘å—æ—¶ï¼š
1. `maxImageHeight` å˜åŒ–
2. è§¦å‘æ¸…ç©ºç¼“å­˜ï¼ˆ`setCellHeights(new Map())`ï¼‰
3. è§¦å‘é‡æ–°æµ‹é‡ï¼ˆ`useLayoutEffect` é‡æ–°æ‰§è¡Œï¼‰
4. è¡¨æ ¼é«˜åº¦æ­£ç¡®æ›´æ–°
5. ç”»å¸ƒé«˜åº¦ä¸è¡¨æ ¼é«˜åº¦ä¿æŒä¸€è‡´ âœ…

**æ•™è®­**ï¼š
- `useEffect` å’Œ `useLayoutEffect` çš„ä¾èµ–æ•°ç»„å¿…é¡»åŒ…å«**æ‰€æœ‰**å½±å“è®¡ç®—ç»“æœçš„å˜é‡
- å¿½ç•¥æŸä¸ªä¾èµ–ä¼šå¯¼è‡´çŠ¶æ€ä¸åŒæ­¥ï¼Œè¡¨ç°ä¸º"æ•°æ®å˜äº†ä½† UI æ²¡å˜"
- åœ¨æ·»åŠ æ–°çš„å¯é…ç½®å‚æ•°æ—¶ï¼Œè¦æ£€æŸ¥æ‰€æœ‰ç›¸å…³çš„ Effect ä¾èµ–æ•°ç»„

### å­—ä½“å¤§å°å˜åŒ–ååº•éƒ¨ç©ºç™½é—®é¢˜ï¼ˆ2025-12-03ï¼‰

**é—®é¢˜**ï¼š
å½“ç”¨æˆ·ä¿®æ”¹åŸºå‡†å­—å·åï¼Œç”»å¸ƒåº•éƒ¨å‡ºç°ä¸€å—ç©ºç™½ï¼Œæ— è®ºå­—å·å˜å¤§è¿˜æ˜¯å˜å°éƒ½ä¼šå‡ºç°**ç›¸åŒå¤§å°**çš„ç©ºç™½ã€‚è°ƒæ•´è¡¨æ ¼å›¾ç‰‡å¤§å°åï¼Œé«˜åº¦åˆæ¢å¤æ­£ç¡®ã€‚

**æ ¹æœ¬åŸå› **ï¼š
åœ¨ `PageCanvas.tsx` çš„ `useLayoutEffect` ä¸­ï¼Œæµ‹é‡æ–‡æœ¬é«˜åº¦æ—¶**å®Œå…¨æ›¿æ¢**äº† `measuredHeights` Mapï¼š

```typescript
// æ—§ä»£ç ï¼ˆé—®é¢˜ï¼‰
if (hasChanges) {
  setMeasuredHeights(newHeights);  // â† å®Œå…¨æ›¿æ¢æ•´ä¸ª Map
}
```

é—®é¢˜åœ¨äºï¼š
1. `newHeights` åªåŒ…å«**æ–‡æœ¬èŠ‚ç‚¹**çš„é«˜åº¦ï¼ˆé€šè¿‡ `textRefs.current` è·å–ï¼‰
2. **è¡¨æ ¼é«˜åº¦**æ˜¯ç”± `TableComponent` é€šè¿‡ `onHeightMeasured` å›è°ƒè®¾ç½®çš„
3. å½“æ‰§è¡Œ `setMeasuredHeights(newHeights)` æ—¶ï¼Œ**è¡¨æ ¼é«˜åº¦è¢«è¦†ç›–ä¸¢å¤±**ï¼
4. è®¡ç®— section é«˜åº¦æ—¶ï¼Œè¡¨æ ¼é«˜åº¦å˜æˆ `undefined`ï¼Œä½¿ç”¨äº†**ä¼°ç®—å€¼**
5. ä¼°ç®—å€¼é€šå¸¸æ¯”å®é™…é«˜åº¦å¤§ï¼Œå¯¼è‡´åº•éƒ¨ç©ºç™½

**ä¸ºä»€ä¹ˆè°ƒæ•´è¡¨æ ¼å›¾ç‰‡å¤§å°åæ­£ç¡®**ï¼š
è°ƒæ•´ `tableImageSize` â†’ `TableComponent` é‡æ–°æµ‹é‡ â†’ é€šè¿‡ `onHeightMeasured` é‡æ–°è®¾ç½®è¡¨æ ¼é«˜åº¦ â†’ Map ä¸­åˆæœ‰äº†æ­£ç¡®çš„è¡¨æ ¼é«˜åº¦ â†’ é«˜åº¦æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
åˆå¹¶æ›´æ–°ï¼Œè€Œä¸æ˜¯å®Œå…¨æ›¿æ¢ï¼Œä¿ç•™å…¶ä»–ç»„ä»¶çš„é«˜åº¦ï¼š

```typescript
// æ–°ä»£ç ï¼ˆä¿®å¤ï¼‰
if (hasChanges) {
  setMeasuredHeights((prev) => {
    const newMap = new Map(prev);  // â† ä¿ç•™åŸæœ‰çš„å€¼
    for (const { key, height } of updates) {
      newMap.set(key, height);  // â† åªæ›´æ–°æ–‡æœ¬ç›¸å…³çš„ key
    }
    return newMap;
  });
}
```

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/PageCanvas.tsx`ï¼šä¿®æ”¹ `useLayoutEffect` ä¸­çš„ `setMeasuredHeights` é€»è¾‘ï¼Œä»å®Œå…¨æ›¿æ¢æ”¹ä¸ºåˆå¹¶æ›´æ–°

**æ•™è®­**ï¼š
- å½“ Map/Object çŠ¶æ€è¢«å¤šä¸ªæ¥æºæ›´æ–°æ—¶ï¼Œä¸èƒ½ç®€å•åœ°æ›¿æ¢ï¼Œè¦åˆå¹¶æ›´æ–°
- è°ƒè¯•æ—¶æ³¨æ„"ç›¸åŒå¤§å°çš„å¼‚å¸¸"ï¼Œå¾€å¾€æŒ‡å‘å›ºå®šçš„ä¼°ç®—å€¼æˆ–é»˜è®¤å€¼
- å½“è°ƒæ•´æŸä¸ªåŠŸèƒ½åé—®é¢˜æ¶ˆå¤±ï¼Œè¦è¿½æº¯è¿™ä¸ªåŠŸèƒ½åšäº†ä»€ä¹ˆç‰¹æ®Šçš„äº‹ï¼ˆæœ¬ä¾‹ï¼šé‡æ–°è®¾ç½®è¡¨æ ¼é«˜åº¦ï¼‰

### å¤šè¡¨æ ¼é«˜åº¦è¿ç»­å˜åŒ–æ—¶åº•éƒ¨ç©ºç™½é—®é¢˜ï¼ˆ2025-12-05ï¼‰

**é—®é¢˜**ï¼š
å½“ä¸Šä¼ åŒ…å«å¤šä¸ªè¡¨æ ¼çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿ç»­è°ƒæ•´è¡¨æ ¼å›¾ç‰‡å¤§å°æˆ–å­—å·æ—¶ï¼Œç”»å¸ƒåº•éƒ¨å¶å°”ä¼šå‡ºç°åŠ è½½ä¸­çš„ç©ºç™½ã€‚è¿™ä¸ªé—®é¢˜æ˜¯æ¦‚ç‡æ€§å‘ç”Ÿçš„ï¼Œéœ€è¦æ‰‹åŠ¨è§¦å‘èƒ½åˆ·æ–°é«˜åº¦çš„åŠŸèƒ½ï¼ˆå¦‚å†æ¬¡è°ƒæ•´å­—å·æˆ–å›¾ç‰‡å¤§å°ï¼‰æ‰èƒ½æ¢å¤æ­£å¸¸ã€‚

**æ ¹æœ¬åŸå›  - å¤šè¡¨æ ¼é«˜åº¦æ›´æ–°çš„ç«æ€æ¡ä»¶**ï¼š

1. **å¤šä¸ª RAF å›è°ƒæ‰§è¡Œæ—¶æœºä¸ç¡®å®š**ï¼š
   - æ¯ä¸ª `TableComponent` ä½¿ç”¨ `requestAnimationFrame` æ¥æŠ¥å‘Šé«˜åº¦
   - å½“å¤šä¸ªè¡¨æ ¼åŒæ—¶å˜åŒ–æ—¶ï¼Œå®ƒä»¬çš„ RAF å›è°ƒå¯èƒ½åœ¨ä¸åŒå¸§æ‰§è¡Œ
   - æŸäº›è¡¨æ ¼å¯èƒ½åœ¨å…¶ä»–è¡¨æ ¼å®Œæˆæµ‹é‡ä¹‹å‰å°±æŠ¥å‘Šäº†é«˜åº¦

2. **æ¸…ç©º cellHeights å¯¼è‡´çš„æ—¶é—´çª—å£é—®é¢˜**ï¼š
   ```typescript
   // TableComponent.tsx
   useEffect(() => {
     setCellHeights(new Map());  // æ¸…ç©ºæ‰€æœ‰é«˜åº¦æµ‹é‡
   }, [fontSize, table, width, fontFamily, maxImageHeight]);
   ```
   å½“ `maxImageHeight` å˜åŒ–æ—¶ï¼Œæ‰€æœ‰å•å…ƒæ ¼é«˜åº¦è¢«æ¸…ç©ºï¼Œä½†æ–°çš„é«˜åº¦æµ‹é‡éœ€è¦æ—¶é—´ã€‚åœ¨è¿™ä¸ªçª—å£å†…ï¼Œ`totalHeight` å¯èƒ½ä½¿ç”¨ä¼°ç®—å€¼è€Œéå®é™…å€¼ã€‚

3. **RAF å–æ¶ˆå¯¼è‡´çš„é«˜åº¦æ›´æ–°ä¸¢å¤±**ï¼š
   ```typescript
   // PageCanvas.tsx
   if (rafRef.current != null) cancelAnimationFrame(rafRef.current);
   ```
   å¿«é€Ÿè¿ç»­å˜åŒ–æ—¶ï¼Œå‰é¢çš„ RAF è¢«å–æ¶ˆï¼Œåªæœ‰æœ€åä¸€ä¸ªæ‰§è¡Œã€‚ä½†æœ€åä¸€ä¸ªå¯èƒ½è¿˜ä¸æ˜¯ç¨³å®šå€¼ã€‚

4. **é«˜åº¦åŠ¨ç”»æœŸé—´çš„æ–°é«˜åº¦å˜åŒ–**ï¼š
   ```typescript
   // preview.tsx CanvasCell
   useEffect(() => {
     // 400ms åŠ¨ç”»
   }, [targetScaledH]);
   ```
   å¦‚æœåœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­åˆæœ‰æ–°çš„é«˜åº¦å˜åŒ–ï¼Œå¤šä¸ªåŠ¨ç”»å¯èƒ½åŒæ—¶è¿è¡Œï¼Œé€ æˆè§†è§‰é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ - ä¸‰å±‚ç¨³å®šæ€§æœºåˆ¶**ï¼š

**å±‚çº§ 1ï¼šPageCanvas ç¨³å®šæ€§æ£€æµ‹**
```typescript
// ä½¿ç”¨ç¨³å®šæ€§æ£€æµ‹ï¼šç­‰å¾…é«˜åº¦ç¨³å®šåå†ä¸ŠæŠ¥
const stabilityDelay = 100; // ç­‰å¾… 100ms ç¡®è®¤é«˜åº¦ç¨³å®š

const reportHeight = useCallback((h: number) => {
  pendingHeightRef.current = h;
  
  // æ¸…é™¤ä¹‹å‰çš„ç¨³å®šæ€§æ£€æµ‹å®šæ—¶å™¨
  if (stabilityTimerRef.current != null) {
    clearTimeout(stabilityTimerRef.current);
  }
  
  // è®¾ç½®ç¨³å®šæ€§æ£€æµ‹ï¼šå¦‚æœ 100ms å†…æ²¡æœ‰æ–°çš„é«˜åº¦å˜åŒ–ï¼Œæ‰ä¸ŠæŠ¥
  stabilityTimerRef.current = window.setTimeout(() => {
    // ä¸ŠæŠ¥æœ€ç»ˆé«˜åº¦
    onMeasured?.(finalHeight);
  }, stabilityDelay);
}, [onMeasured]);
```

**å±‚çº§ 2ï¼šTableComponent æµ‹é‡çŠ¶æ€æ ‡è®°**
```typescript
// æ ‡è®°æ˜¯å¦æ­£åœ¨é‡æ–°æµ‹é‡
const [isMeasuring, setIsMeasuring] = useState(false);

useEffect(() => {
  setIsMeasuring(true); // æ ‡è®°ä¸ºæ­£åœ¨æµ‹é‡
  setCellHeights(new Map());
}, [fontSize, table, width, fontFamily, maxImageHeight]);

// æµ‹é‡å®Œæˆåæ¸…é™¤æ ‡è®°
if (measuredCount > 0) {
  setIsMeasuring(false);
}

// æ­£åœ¨æµ‹é‡æ—¶ä¸æŠ¥å‘Šé«˜åº¦
if (isMeasuring) return;
```

**å±‚çº§ 3ï¼šCanvasCell åŠ¨ç”»å–æ¶ˆæœºåˆ¶**
```typescript
useEffect(() => {
  let rafId: number | null = null;
  let cancelled = false;
  
  const animate = (currentTime: number) => {
    if (cancelled) return;
    // åŠ¨ç”»é€»è¾‘...
    if (progress < 1 && !cancelled) {
      rafId = requestAnimationFrame(animate);
    }
  };
  
  rafId = requestAnimationFrame(animate);
  
  // æ¸…ç†å‡½æ•°ï¼šå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„åŠ¨ç”»
  return () => {
    cancelled = true;
    if (rafId != null) {
      cancelAnimationFrame(rafId);
    }
  };
}, [targetScaledH]);
```

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/PageCanvas.tsx`ï¼š
  - æ·»åŠ ç¨³å®šæ€§æ£€æµ‹æœºåˆ¶ï¼ˆ100ms å»¶è¿Ÿç¡®è®¤é«˜åº¦ç¨³å®šï¼‰
  - æ·»åŠ  `stabilityTimerRef` å’Œ `pendingHeightRef`
- `web/src/renderer/canvas/TableComponent.tsx`ï¼š
  - æ·»åŠ  `isMeasuring` çŠ¶æ€æ ‡è®°
  - æµ‹é‡å®Œæˆåæ‰æ¸…é™¤æ ‡è®°
  - æ­£åœ¨æµ‹é‡æ—¶ä¸æŠ¥å‘Šé«˜åº¦
  - æ·»åŠ  50ms çš„ç¨³å®šæ€§å»¶è¿Ÿ
- `web/src/pages/preview.tsx`ï¼š
  - ä¿®å¤åŠ¨ç”»å–æ¶ˆæœºåˆ¶
  - ç¼©çŸ­åŠ¨ç”»æ—¶é•¿ä» 400ms åˆ° 300ms

**æ•°æ®æµæ”¹è¿›**ï¼š
```
ç”¨æˆ·è°ƒæ•´è¡¨æ ¼å›¾ç‰‡å¤§å°
  â†“ maxImageHeight å˜åŒ–
  â†“ TableComponent: setIsMeasuring(true)ï¼Œæ¸…ç©º cellHeights
  â†“ RAF é‡æ–°æµ‹é‡å•å…ƒæ ¼
  â†“ æµ‹é‡å®Œæˆ â†’ setIsMeasuring(false)
  â†“ ç­‰å¾… 50ms ç¡®è®¤ç¨³å®š
  â†“ TableComponent æŠ¥å‘Š totalHeight
  â†“ PageCanvas æ›´æ–° measuredHeights
  â†“ ç­‰å¾… 100ms ç¡®è®¤ç¨³å®šï¼ˆæ— æ–°çš„é«˜åº¦å˜åŒ–ï¼‰
  â†“ PageCanvas æŠ¥å‘Šæœ€ç»ˆé«˜åº¦
  â†“ preview.tsx å–æ¶ˆæ—§åŠ¨ç”»ï¼Œå¼€å§‹æ–°åŠ¨ç”»
  â†“ 300ms åç”»å¸ƒé«˜åº¦ç¨³å®š âœ…
```

**æ•™è®­**ï¼š
- å¤šä¸ªç»„ä»¶å¼‚æ­¥æ›´æ–°åŒä¸€çŠ¶æ€æ—¶ï¼Œéœ€è¦ç¨³å®šæ€§æ£€æµ‹æœºåˆ¶
- ä½¿ç”¨ `isMeasuring` æ ‡è®°å¯ä»¥é¿å…åœ¨æµ‹é‡è¿‡ç¨‹ä¸­æŠ¥å‘Šä¸å‡†ç¡®çš„å€¼
- åŠ¨ç”»æ•ˆæœéœ€è¦æ­£ç¡®çš„æ¸…ç†æœºåˆ¶ï¼Œé¿å…å¤šä¸ªåŠ¨ç”»åŒæ—¶è¿è¡Œ
- å¯¹äºæ¦‚ç‡æ€§é—®é¢˜ï¼Œé€šå¸¸æ˜¯ç«æ€æ¡ä»¶å¯¼è‡´ï¼Œéœ€è¦ä»æ—¶åºè§’åº¦åˆ†æ

### è¶…å¤§è¡¨æ ¼ï¼ˆ130è¡Œï¼‰RAFé€’å½’é“¾å¯¼è‡´å´©æºƒï¼ˆ2025-12-05ï¼‰

**é—®é¢˜**ï¼š
ä¸Šä¼ åŒ…å« 130 è¡Œ Ã— 5 åˆ— = 650 ä¸ªå•å…ƒæ ¼çš„è¶…å¤§è¡¨æ ¼åï¼Œç”»å¸ƒåŠ è½½å®Œæˆå‡ ç§’åæµè§ˆå™¨å´©æºƒï¼Œæ˜¾ç¤ºå“­è„¸ï¼ˆAw, Snap!ï¼‰ã€‚

**æ ¹æœ¬åŸå›  - RAF é€’å½’é“¾æ²¡æœ‰è¢«æ¸…ç†**ï¼š

åœ¨ `TableComponent.tsx` çš„æµ‹é‡é€»è¾‘ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„ RAF æ³„æ¼é—®é¢˜ï¼š

```typescript
// é—®é¢˜ä»£ç ï¼ˆç¬¬ 292-294 è¡Œï¼‰
if (hasUnmeasured && retryCountRef.current < maxRetries) {
  retryCountRef.current++;
  requestAnimationFrame(measure);  // â† é€’å½’RAFæ²¡æœ‰è¢«è¿½è¸ªï¼
}

// æ¸…ç†å‡½æ•°åªå–æ¶ˆåˆå§‹RAF
return () => {
  cancelled = true;
  cancelAnimationFrame(rafId);  // â† åªå–æ¶ˆäº†åˆå§‹RAF
  // âŒ é€’å½’åˆ›å»ºçš„RAFæ²¡æœ‰è¢«å–æ¶ˆï¼
};
```

**é—®é¢˜åˆ†æ**ï¼š
1. **é€’å½’ RAF é“¾**ï¼š
   - åˆå§‹è°ƒç”¨ `requestAnimationFrame(measure)` åˆ›å»º `rafId`
   - å¦‚æœæœ‰æœªæµ‹é‡çš„èŠ‚ç‚¹ï¼Œ`measure` å‡½æ•°å†…éƒ¨å†æ¬¡è°ƒç”¨ `requestAnimationFrame(measure)`
   - è¿™ä¸ªé€’å½’ RAF æ²¡æœ‰è¢«è¿½è¸ªï¼Œæ¸…ç†å‡½æ•°æ— æ³•å–æ¶ˆå®ƒ

2. **å¤§è¡¨æ ¼é›ªå´©æ•ˆåº”**ï¼š
   ```
   130 è¡Œ Ã— 5 åˆ— = 650 ä¸ªå•å…ƒæ ¼
   æ¯ä¸ªå•å…ƒæ ¼å¯èƒ½éœ€è¦å¤šæ¬¡æµ‹é‡ï¼ˆmaxRetries = 5ï¼‰
   650 Ã— 5 = 3250+ ä¸ª RAF é“¾åŒæ—¶è¿è¡Œ
   æ¯ä¸ª RAF é“¾éƒ½åœ¨ç­‰å¾…ä¸‹ä¸€å¸§
   æµè§ˆå™¨å†…å­˜å’Œ RAF é˜Ÿåˆ—çˆ†ç‚¸ â†’ å´©æºƒ ğŸ’¥
   ```

3. **ä¸ºä»€ä¹ˆå°è¡¨æ ¼æ²¡é—®é¢˜**ï¼š
   - å°è¡¨æ ¼ï¼ˆ< 50è¡Œï¼‰RAF é“¾æ•°é‡å°‘ï¼Œæµè§ˆå™¨å¯ä»¥å¤„ç†
   - å¤§è¡¨æ ¼ RAF é“¾æ•°é‡è¶…è¿‡æµè§ˆå™¨é™åˆ¶ï¼Œè§¦å‘å´©æºƒ

**è§£å†³æ–¹æ¡ˆ - å¤§è¡¨æ ¼è·³è¿‡é€å•å…ƒæ ¼æµ‹é‡**ï¼š

å¯¹äºè¶…è¿‡ 50 è¡Œçš„å¤§è¡¨æ ¼ï¼Œå®Œå…¨è·³è¿‡é€å•å…ƒæ ¼æµ‹é‡ï¼Œç›´æ¥ä½¿ç”¨ç»Ÿä¸€é«˜åº¦ï¼š

```typescript
useLayoutEffect(() => {
  const isLargeTable = table.rows.length > 50;
  
  // å¤§è¡¨æ ¼ä¼˜åŒ–ï¼šç›´æ¥è·³è¿‡æµ‹é‡ï¼Œä½¿ç”¨ç»Ÿä¸€é«˜åº¦
  if (isLargeTable) {
    setIsMeasuring(false);
    return;  // â† æå‰è¿”å›ï¼Œä¸åˆ›å»ºä»»ä½•RAF
  }
  
  let cancelled = false;
  let retryRafId: number | null = null;  // â† è¿½è¸ªé€’å½’RAF

  const measure = () => {
    if (cancelled) return;
    
    // ... æµ‹é‡é€»è¾‘
    
    // é€’å½’RAFæ—¶è¿½è¸ªID
    if (hasUnmeasured && retryCountRef.current < maxRetries && !cancelled) {
      retryCountRef.current++;
      retryRafId = requestAnimationFrame(measure);  // â† ä¿å­˜RAF ID
    }
  };

  const rafId = requestAnimationFrame(measure);

  return () => {
    cancelled = true;
    cancelAnimationFrame(rafId);
    // å…³é”®ï¼šå–æ¶ˆé€’å½’åˆ›å»ºçš„RAF
    if (retryRafId != null) {
      cancelAnimationFrame(retryRafId);
    }
  };
}, [loadedImageCount, fontSize, table, width, fontFamily, maxImageHeight]);
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š

| è¡¨æ ¼è§„æ¨¡ | ç­–ç•¥ | RAFæ•°é‡ | æ€§èƒ½ |
|---------|------|--------|------|
| < 50è¡Œ | é€å•å…ƒæ ¼æµ‹é‡ | < 250 | ç²¾ç¡® |
| â‰¥ 50è¡Œ | ç»Ÿä¸€é«˜åº¦ï¼Œè·³è¿‡æµ‹é‡ | 0 | æå¿«ï¼Œä¸å´©æºƒ âœ… |

**ä¸ºä»€ä¹ˆ 50 è¡Œæ˜¯é˜ˆå€¼**ï¼š
- 50 è¡Œ Ã— 5 åˆ— Ã— 5 æ¬¡é‡è¯• = 1250 ä¸ª RAFï¼ˆæµè§ˆå™¨å¯å¤„ç†ï¼‰
- 130 è¡Œ Ã— 5 åˆ— Ã— 5 æ¬¡é‡è¯• = 3250 ä¸ª RAFï¼ˆè¶…å‡ºæµè§ˆå™¨é™åˆ¶ï¼‰
- 50 è¡Œæ˜¯å®‰å…¨ä¸æ€§èƒ½çš„å¹³è¡¡ç‚¹

**ç»Ÿä¸€é«˜åº¦çš„è®¡ç®—é€»è¾‘**ï¼š
```typescript
const getUnifiedDataRowHeight = () => {
  let maxHeight = minRowHeight;
  let hasMeasuredCells = false;

  // å°è¯•ä»å·²æµ‹é‡çš„å•å…ƒæ ¼è·å–é«˜åº¦
  for (let rowIdx = 0; rowIdx < table.rows.length; rowIdx++) {
    for (let colIdx = 0; colIdx < colCount; colIdx++) {
      const key = `${rowIdx}-${colIdx}`;
      const cellHeight = cellHeights.get(key);
      if (cellHeight && cellHeight > 0) {
        hasMeasuredCells = true;
        maxHeight = Math.max(maxHeight, cellHeight);
      }
    }
  }

  // å¤§è¡¨æ ¼ï¼šå¦‚æœæ²¡æœ‰æµ‹é‡æ•°æ®ï¼Œä½¿ç”¨å¯å‘å¼ä¼°ç®—
  if (!hasMeasuredCells) {
    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡
    let hasImages = false;
    for (const row of table.rows) {
      for (const cell of row) {
        if (cell.is_image) {
          hasImages = true;
          break;
        }
      }
      if (hasImages) break;
    }
    
    maxHeight = hasImages ? maxImageHeight : minRowHeight;
  }

  return maxHeight + cellPadding * 2;
};
```

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `web/src/renderer/canvas/TableComponent.tsx`ï¼š
  - æ·»åŠ å¤§è¡¨æ ¼æ£€æµ‹ï¼ˆ50è¡Œé˜ˆå€¼ï¼‰
  - å¤§è¡¨æ ¼è·³è¿‡æµ‹é‡ï¼Œç›´æ¥ä½¿ç”¨ç»Ÿä¸€é«˜åº¦
  - è¿½è¸ªé€’å½’RAF IDï¼Œç¡®ä¿æ¸…ç†
  - æ·»åŠ  `cancelled` æ£€æŸ¥åˆ°é€’å½’æ¡ä»¶

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… **130è¡Œè¡¨æ ¼ä¸å†å´©æºƒ**ï¼šè·³è¿‡æµ‹é‡ï¼Œ0ä¸ªRAF
- âœ… **åŠ è½½é€Ÿåº¦æå¿«**ï¼šæ— éœ€ç­‰å¾…æµ‹é‡å®Œæˆ
- âœ… **å†…å­˜ä½¿ç”¨ç¨³å®š**ï¼šæ— RAFé“¾å †ç§¯
- âœ… **å°è¡¨æ ¼ä¿æŒç²¾ç¡®**ï¼š< 50è¡Œä»ç„¶é€å•å…ƒæ ¼æµ‹é‡
- âœ… **è‡ªé€‚åº”ä¼˜åŒ–**ï¼šæ ¹æ®è¡¨æ ¼å¤§å°è‡ªåŠ¨é€‰æ‹©ç­–ç•¥

**æ•°æ®æµå¯¹æ¯”**ï¼š

**å°è¡¨æ ¼ï¼ˆ< 50è¡Œï¼‰**ï¼š
```
åŠ è½½è¡¨æ ¼ â†’ é€å•å…ƒæ ¼æµ‹é‡ â†’ ç²¾ç¡®é«˜åº¦ â†’ æ¸²æŸ“
```

**å¤§è¡¨æ ¼ï¼ˆâ‰¥ 50è¡Œï¼‰**ï¼š
```
åŠ è½½è¡¨æ ¼ â†’ è·³è¿‡æµ‹é‡ â†’ ç»Ÿä¸€é«˜åº¦ï¼ˆä¼°ç®—ï¼‰â†’ ç«‹å³æ¸²æŸ“ âœ…
```

**æ•™è®­**ï¼š
- **é€’å½’ RAF å¿…é¡»è¿½è¸ªå¹¶æ¸…ç†**ï¼Œä¸èƒ½åªæ¸…ç†åˆå§‹ RAF
- **å¤§æ•°æ®é‡åœºæ™¯éœ€è¦ç‰¹æ®Šä¼˜åŒ–**ï¼Œä¸èƒ½ç”¨å°æ•°æ®çš„ç­–ç•¥
- **æµè§ˆå™¨ RAF é˜Ÿåˆ—æœ‰é™åˆ¶**ï¼Œè¶…è¿‡é˜ˆå€¼ä¼šå´©æºƒ
- **æ€§èƒ½ä¼˜åŒ–è¦åˆ†å±‚**ï¼šå°æ•°æ®ç²¾ç¡®ï¼Œå¤§æ•°æ®å¿«é€Ÿ
- **50è¡Œæ˜¯ä¸€ä¸ªç»éªŒé˜ˆå€¼**ï¼ŒåŸºäºæµè§ˆå™¨RAFé™åˆ¶ï¼ˆçº¦1000-2000ä¸ªï¼‰
- **å´©æºƒé—®é¢˜è¦ä»èµ„æºé™åˆ¶è§’åº¦åˆ†æ**ï¼Œä¸ä»…ä»…æ˜¯ç®—æ³•ä¼˜åŒ–
