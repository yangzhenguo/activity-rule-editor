# 画布直接编辑功能

## 功能说明

画布上的文字和图片现在支持直接点击编辑，无需打开侧边栏。

## 使用方法

### 编辑文字
1. **鼠标悬浮**：悬浮在文字上时，显示蓝色虚线边框
2. **点击编辑**：点击文字，原位置出现输入框
3. **编辑内容**：直接输入新内容
4. **保存**：
   - 单行文字：按 Enter 或点击其他地方
   - 多行文字：点击其他地方
   - 按 Esc 取消编辑

### 替换图片
1. **鼠标悬浮**：悬浮在图片上时，显示蓝色虚线边框
2. **点击图片**：自动弹出上传弹窗
3. **上传方式**：
   - 点击中间区域选择文件
   - 直接拖拽图片到弹窗
4. **预览**：上传后在弹窗中预览
5. **保存**：点击"保存"按钮应用更改

## 可编辑元素

- ✅ 区域名称（画布顶部标题）
- ✅ Block 标题（大标题）
- ✅ Section 标题
- ✅ Section 内容（多行文本）
- ✅ 奖励名称
- ✅ 奖励描述
- ✅ 奖励图片

## 技术实现

### 关键组件

1. **ImageUploadModal** (`web/src/components/ImageUploadModal.tsx`)
   - 图片上传弹窗
   - 支持点击上传和拖拽上传
   - 实时预览

2. **PageCanvas** (`web/src/renderer/canvas/PageCanvas.tsx`)
   - 所有文字添加悬浮边框和点击事件
   - 所有图片添加点击事件
   - 通过回调传递编辑信息

3. **Preview** (`web/src/pages/preview.tsx`)
   - 管理编辑状态
   - 渲染浮动输入框
   - 处理数据保存

### 数据流

```
用户点击元素 
  ↓
PageCanvas 触发回调（onTextClick / onImageClick）
  ↓
Preview 更新编辑状态
  ↓
显示输入框或弹窗
  ↓
用户编辑完成
  ↓
保存到 data 状态
  ↓
同步到 allSheets
  ↓
画布自动重新渲染
```

### 坐标计算

文字编辑使用 Canvas 的绝对坐标：
```typescript
const absPos = textNode.getAbsolutePosition();
// absPos 已经是屏幕坐标，无需转换
```

## 注意事项

1. **数据持久化**：编辑后的数据保存在内存中，刷新页面会重置
2. **图片格式**：上传的图片以 data URL 格式存储
3. **只能编辑**：当前版本不支持添加新元素（奖励、段落等）
4. **自动布局**：文字修改后，画布高度会自动重新计算

## 与旧版本的区别

| 特性 | 旧版本（侧边栏） | 新版本（画布直接编辑） |
|------|----------------|-------------------|
| 编辑方式 | 打开侧边栏 | 点击元素 |
| 所见即所得 | ❌ | ✅ |
| 快速编辑 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 批量操作 | ✅ | ❌ |
| 添加元素 | ✅ | ❌（未来可扩展） |

## 键盘快捷键

- **Enter**：保存单行文字编辑
- **Esc**：取消编辑
- **失焦**：自动保存

## 未来优化建议

1. 支持撤销/重做（Ctrl+Z / Ctrl+Y）
2. 支持添加新奖励和段落
3. 支持批量选择和编辑
4. 图片上传到后端 blob store
5. 自动保存草稿

